/*! angular-img-cropper 31-10-2020 */

angular.module("angular-img-cropper",[]).directive("imageCropper",["$document","$window","imageCropperDataShare",function(t,i,I){return{scope:{image:"=",imageDimensions:"=",croppedImage:"=",croppedImageFull:"=",cropWidth:"=",cropHeight:"=",keepAspect:"=",touchRadius:"=",cropAreaBounds:"=",cropperColor:"@",minWidth:"=",minHeight:"=",allowOverstep:"="},restrict:"A",link:function(l,n,a){var r;l.cropperColor=l.cropperColor||"rgba(255,228,0,1)";var t=t||function(t,i){for(var e in i)i.hasOwnProperty(e)&&(t[e]=i[e]);function s(){this.constructor=t}s.prototype=i.prototype,t.prototype=new s},i=(e.prototype.setDrag=function(t){this.drag=t,this.setOver(t)},e.prototype.draw=function(t){},e.prototype.setOver=function(t){this.over=t},e.prototype.touchInBounds=function(t,i){return t>this.position.x-this.radius&&t<this.position.x+this.radius&&i>this.position.y-this.radius&&i<this.position.y+this.radius},e.prototype.getPosition=function(){return this.position},e.prototype.setPosition=function(t,i){this.position.x=t,this.position.y=i},e);function e(t,i,e){this.over=!1,this.drag=!1,this.position=new w(t,i),this.offset=new w(0,0),this.radius=e}var m=(o.prototype.borrow=function(t,i){if(null==this.firstAvailable)throw"Pool exhausted";this.borrowed++;var e=this.firstAvailable;return this.firstAvailable=e.getNext(),e.x=t,e.y=i,e},o.prototype.returnPoint=function(t){this.borrowed--,t.x=0,t.y=0,t.setNext(this.firstAvailable),this.firstAvailable=t},o);function o(t){this.borrowed=0,o.instance=this;for(var i=null,e=0;e<t;e++)var s,i=0===e?(this.firstAvailable=new w,this.firstAvailable):(s=new w,i.setNext(s),s)}var h=(s.init=function(t){this.canvas=t,this.ctx=this.canvas.getContext("2d")},s.DEG2RAD=.0174532925,s);function s(){}var c,g=(t(p,c=i),p.prototype.draw=function(t){this.over||this.drag?this.drawIcon(t,this.scaledIconPoints):this.drawIcon(t,this.iconPoints)},p.prototype.getDragIconPoints=function(t,i){var e=17*i,s=14*i,o=8*i,i=4*i;t.push(m.instance.borrow(-i/2,e-o)),t.push(m.instance.borrow(-s/2,e-o)),t.push(m.instance.borrow(0,e)),t.push(m.instance.borrow(s/2,e-o)),t.push(m.instance.borrow(i/2,e-o)),t.push(m.instance.borrow(i/2,i/2)),t.push(m.instance.borrow(e-o,i/2)),t.push(m.instance.borrow(e-o,s/2)),t.push(m.instance.borrow(e,0)),t.push(m.instance.borrow(e-o,-s/2)),t.push(m.instance.borrow(e-o,-i/2)),t.push(m.instance.borrow(i/2,-i/2)),t.push(m.instance.borrow(i/2,o-e)),t.push(m.instance.borrow(s/2,o-e)),t.push(m.instance.borrow(0,-e)),t.push(m.instance.borrow(-s/2,o-e)),t.push(m.instance.borrow(-i/2,o-e)),t.push(m.instance.borrow(-i/2,-i/2)),t.push(m.instance.borrow(o-e,-i/2)),t.push(m.instance.borrow(o-e,-s/2)),t.push(m.instance.borrow(-e,0)),t.push(m.instance.borrow(o-e,s/2)),t.push(m.instance.borrow(o-e,i/2)),t.push(m.instance.borrow(-i/2,i/2))},p.prototype.drawIcon=function(t,i){t.beginPath(),t.moveTo(i[0].x+this.position.x,i[0].y+this.position.y);for(var e=0;e<i.length;e++){var s=i[e];t.lineTo(s.x+this.position.x,s.y+this.position.y)}t.closePath(),t.fillStyle=l.cropperColor,t.fill()},p.prototype.recalculatePosition=function(t){t=t.getCentre();this.setPosition(t.x,t.y),m.instance.returnPoint(t)},p);function p(t,i,e){c.call(this,t,i,e),this.iconPoints=new Array,this.scaledIconPoints=new Array,this.getDragIconPoints(this.iconPoints,1),this.getDragIconPoints(this.scaledIconPoints,1.2)}var u,d=(t(v,u=i),v.prototype.drawCornerBorder=function(t){var i=10;(this.over||this.drag)&&(i=12);var e=1,s=1;this.horizontalNeighbour.position.x<this.position.x&&(e=-1),this.verticalNeighbour.position.y<this.position.y&&(s=-1),t.beginPath(),t.lineJoin="miter",t.moveTo(this.position.x,this.position.y),t.lineTo(this.position.x+i*e,this.position.y),t.lineTo(this.position.x+i*e,this.position.y+i*s),t.lineTo(this.position.x,this.position.y+i*s),t.lineTo(this.position.x,this.position.y),t.closePath(),t.lineWidth=2,t.strokeStyle=l.cropperColor,t.stroke()},v.prototype.drawCornerFill=function(t){var i=10;(this.over||this.drag)&&(i=12);var e=1,s=1;this.horizontalNeighbour.position.x<this.position.x&&(e=-1),this.verticalNeighbour.position.y<this.position.y&&(s=-1),t.beginPath(),t.moveTo(this.position.x,this.position.y),t.lineTo(this.position.x+i*e,this.position.y),t.lineTo(this.position.x+i*e,this.position.y+i*s),t.lineTo(this.position.x,this.position.y+i*s),t.lineTo(this.position.x,this.position.y),t.closePath(),t.fillStyle="rgba(0,0,0,1)",t.fill()},v.prototype.moveX=function(t){this.setPosition(t,this.position.y)},v.prototype.moveY=function(t){this.setPosition(this.position.x,t)},v.prototype.move=function(t,i){this.setPosition(t,i),this.verticalNeighbour.moveX(t),this.horizontalNeighbour.moveY(i)},v.prototype.addHorizontalNeighbour=function(t){this.horizontalNeighbour=t},v.prototype.addVerticalNeighbour=function(t){this.verticalNeighbour=t},v.prototype.getHorizontalNeighbour=function(){return this.horizontalNeighbour},v.prototype.getVerticalNeighbour=function(){return this.verticalNeighbour},v.prototype.draw=function(t){this.drawCornerFill(t),this.drawCornerBorder(t)},v);function v(t,i,e){u.call(this,t,i,e)}var f=(y.prototype.getWidth=function(){return this.right-this.left},y.prototype.getHeight=function(){return this.bottom-this.top},y.prototype.getCentre=function(){var t=this.getWidth(),i=this.getHeight();return m.instance.borrow(this.left+t/2,this.top+i/2)},y);function y(t,i,e,s){void 0===t&&(t=0),void 0===i&&(i=0),void 0===e&&(e=0),void 0===s&&(s=0),this.left=t,this.right=t+e,this.top=i,this.bottom=i+s}var w=(b.prototype.setNext=function(t){this.next=t},b.prototype.getNext=function(){return this.next},b);function b(t,i){void 0===t&&(t=0),void 0===i&&(i=0),this.x=t,this.y=i}var x=function(t,i,e){void 0===t&&(t=0),void 0===i&&(i=0),void 0===e&&(e=0),this.id=0,this.x=t,this.y=i,this.id=e},P=(C.prototype.resizeCanvas=function(t,i){this.canvas.width=t,this.canvas.height=i,this.buffer.width=t,this.buffer.height=i,this.draw(this.ctx)},C.prototype.draw=function(t){var i=this.getBounds();if(this.srcImage){t.clearRect(0,0,this.canvasWidth,this.canvasHeight);var e=this.srcImage.height/this.srcImage.width,s=this.canvasHeight/this.canvasWidth,o=this.canvasWidth,n=this.canvasHeight;e<s?(o=this.canvasWidth,n=this.canvasWidth*e):(n=this.canvasHeight,o=this.canvasHeight/e),this.ratioW=o/this.srcImage.width,this.ratioH=n/this.srcImage.height,s<e?this.drawImageIOSFix(t,this.srcImage,0,0,this.srcImage.width,this.srcImage.height,this.buffer.width/2-o/2,0,o,n):this.drawImageIOSFix(t,this.srcImage,0,0,this.srcImage.width,this.srcImage.height,0,this.buffer.height/2-n/2,o,n),this.buffer.getContext("2d").drawImage(this.canvas,0,0,this.canvasWidth,this.canvasHeight),t.fillStyle="rgba(0, 0, 0, 0.7)",t.fillRect(0,0,this.canvasWidth,this.canvasHeight),t.drawImage(this.buffer,i.left,i.top,Math.max(i.getWidth(),1),Math.max(i.getHeight(),1),i.left,i.top,i.getWidth(),i.getHeight());for(var r=0;r<this.markers.length;r++)this.markers[r].draw(t);this.center.draw(t),t.lineWidth=2,t.strokeStyle=l.cropperColor,t.strokeRect(i.left,i.top,i.getWidth(),i.getHeight())}else t.fillStyle="rgba(192,192,192,1)",t.fillRect(0,0,this.canvas.width,this.canvas.height)},C.prototype.dragCrop=function(t,i,e){var s=this.getBounds(),o=t-s.getWidth()/2,n=t+s.getWidth()/2,r=i-s.getHeight()/2,a=i+s.getHeight()/2;n>=this.maxXClamp&&(t=this.maxXClamp-s.getWidth()/2),o<=this.minXClamp&&(t=s.getWidth()/2+this.minXClamp),r<this.minYClamp&&(i=s.getHeight()/2+this.minYClamp),a>=this.maxYClamp&&(i=this.maxYClamp-s.getHeight()/2),this.tl.moveX(t-s.getWidth()/2),this.tl.moveY(i-s.getHeight()/2),this.tr.moveX(t+s.getWidth()/2),this.tr.moveY(i-s.getHeight()/2),this.bl.moveX(t-s.getWidth()/2),this.bl.moveY(i+s.getHeight()/2),this.br.moveX(t+s.getWidth()/2),this.br.moveY(i+s.getHeight()/2),e.setPosition(t,i),l.cropAreaBounds&&this.imageSet&&(l.cropAreaBounds=this.getCropBounds(),l.$apply())},C.prototype.enforceMinSize=function(t,i,e){var s=t-e.getHorizontalNeighbour().getPosition().x,o=i-e.getVerticalNeighbour().getPosition().y,n=l.minWidth-Math.abs(s),r=l.minHeight-Math.abs(o);return 0==s||0==o?(t=e.getPosition().x,i=e.getPosition().y):(l.keepAspect?0<n&&0<r/this.aspectRatio?n>r/this.aspectRatio?(s<0?t-=n:t+=n,o<0?i-=n*this.aspectRatio:i+=n*this.aspectRatio):(o<0?i-=r:i+=r,s<0?t-=r/this.aspectRatio:t+=r/this.aspectRatio):0<n?(s<0?t-=n:t+=n,o<0?i-=n*this.aspectRatio:i+=n*this.aspectRatio):0<r&&(o<0?i-=r:i+=r,s<0?t-=r/this.aspectRatio:t+=r/this.aspectRatio):(0<n&&(s<0?t-=n:t+=n),0<r&&(o<0?i-=r:i+=r)),(t<this.minXClamp||t>this.maxXClamp||i<this.minYClamp||i>this.maxYClamp)&&(t=e.getPosition().x,i=e.getPosition().y)),m.instance.borrow(t,i)},C.prototype.dragCorner=function(t,i,e){var s,o,n=0,r=0,a=0,h=0,c=0,g=0,p=0,u=0,d=0;l.keepAspect?(a=(s=e.getHorizontalNeighbour().getVerticalNeighbour()).getPosition().x,h=s.getPosition().y,t<=s.getPosition().x?i<=s.getPosition().y?(n=a-100/this.aspectRatio,r=h-100/this.aspectRatio*this.aspectRatio,0<(d=this.getSide(m.instance.borrow(n,r),s.getPosition(),m.instance.borrow(t,i)))?(g=(c=Math.abs(s.getPosition().y-i))/this.aspectRatio,p=s.getPosition().y-c,u=s.getPosition().x-g,o=this.enforceMinSize(u,p,e),e.move(o.x,o.y),m.instance.returnPoint(o)):d<0&&(c=(g=Math.abs(s.getPosition().x-t))*this.aspectRatio,p=s.getPosition().y-c,u=s.getPosition().x-g,o=this.enforceMinSize(u,p,e),e.move(o.x,o.y),m.instance.returnPoint(o))):(n=a-100/this.aspectRatio,r=h+100/this.aspectRatio*this.aspectRatio,0<(d=this.getSide(m.instance.borrow(n,r),s.getPosition(),m.instance.borrow(t,i)))?(c=(g=Math.abs(s.getPosition().x-t))*this.aspectRatio,p=s.getPosition().y+c,u=s.getPosition().x-g,o=this.enforceMinSize(u,p,e),e.move(o.x,o.y),m.instance.returnPoint(o)):d<0&&(g=(c=Math.abs(s.getPosition().y-i))/this.aspectRatio,p=s.getPosition().y+c,u=s.getPosition().x-g,o=this.enforceMinSize(u,p,e),e.move(o.x,o.y),m.instance.returnPoint(o))):i<=s.getPosition().y?(n=a+100/this.aspectRatio,r=h-100/this.aspectRatio*this.aspectRatio,(d=this.getSide(m.instance.borrow(n,r),s.getPosition(),m.instance.borrow(t,i)))<0?(g=(c=Math.abs(s.getPosition().y-i))/this.aspectRatio,p=s.getPosition().y-c,u=s.getPosition().x+g,o=this.enforceMinSize(u,p,e),e.move(o.x,o.y),m.instance.returnPoint(o)):0<d&&(c=(g=Math.abs(s.getPosition().x-t))*this.aspectRatio,p=s.getPosition().y-c,u=s.getPosition().x+g,o=this.enforceMinSize(u,p,e),e.move(o.x,o.y),m.instance.returnPoint(o))):(n=a+100/this.aspectRatio,r=h+100/this.aspectRatio*this.aspectRatio,(d=this.getSide(m.instance.borrow(n,r),s.getPosition(),m.instance.borrow(t,i)))<0?(c=(g=Math.abs(s.getPosition().x-t))*this.aspectRatio,p=s.getPosition().y+c,u=s.getPosition().x+g,o=this.enforceMinSize(u,p,e),e.move(o.x,o.y),m.instance.returnPoint(o)):0<d&&(g=(c=Math.abs(s.getPosition().y-i))/this.aspectRatio,p=s.getPosition().y+c,u=s.getPosition().x+g,o=this.enforceMinSize(u,p,e),e.move(o.x,o.y),m.instance.returnPoint(o)))):(o=this.enforceMinSize(t,i,e),e.move(o.x,o.y),m.instance.returnPoint(o)),this.center.recalculatePosition(this.getBounds()),l.cropAreaBounds&&this.imageSet&&(l.cropAreaBounds=this.getCropBounds(),l.$apply())},C.prototype.getSide=function(t,i,e){i=this.sign((i.x-t.x)*(e.y-t.y)-(i.y-t.y)*(e.x-t.x));return m.instance.returnPoint(t),m.instance.returnPoint(e),i},C.prototype.sign=function(t){return+t===t?0===t?t:0<t?1:-1:NaN},C.prototype.handleRelease=function(t){if(null!=t){for(var i=0,e=0;e<this.currentDragTouches.length;e++)t.id==this.currentDragTouches[e].id&&(this.currentDragTouches[e].dragHandle.setDrag(!1),t.dragHandle=null,i=e);this.currentDragTouches.splice(i,1),this.draw(this.ctx)}},C.prototype.handleMove=function(t){for(var i=!1,e=0;e<this.currentDragTouches.length;e++)if(t.id==this.currentDragTouches[e].id&&null!=this.currentDragTouches[e].dragHandle){var s=this.currentDragTouches[e],o=this.clampPosition(t.x-s.dragHandle.offset.x,t.y-s.dragHandle.offset.y);t.x=o.x,t.y=o.y,m.instance.returnPoint(o),s.dragHandle instanceof d?this.dragCorner(t.x,t.y,s.dragHandle):this.dragCrop(t.x,t.y,s.dragHandle),i=this.currentlyInteracting=!0,I.setPressed(this.canvas);break}if(!i){for(var n=0;n<this.markers.length;n++){var r=this.markers[n];if(r.touchInBounds(t.x,t.y)){t.dragHandle=r,this.currentDragTouches.push(t),r.setDrag(!0),t.dragHandle.offset.x=t.x-t.dragHandle.getPosition().x,t.dragHandle.offset.y=t.y-t.dragHandle.getPosition().y,this.dragCorner(t.x-t.dragHandle.offset.x,t.y-t.dragHandle.offset.y,t.dragHandle);break}}null==t.dragHandle&&this.center.touchInBounds(t.x,t.y)&&(t.dragHandle=this.center,this.currentDragTouches.push(t),t.dragHandle.setDrag(!0),t.dragHandle.offset.x=t.x-t.dragHandle.getPosition().x,t.dragHandle.offset.y=t.y-t.dragHandle.getPosition().y,this.dragCrop(t.x-t.dragHandle.offset.x,t.y-t.dragHandle.offset.y,t.dragHandle))}},C.prototype.updateClampBounds=function(){if(l.allowOverstep)return this.minXClamp=0,this.minYClamp=0,this.maxXClamp=this.canvas.width,void(this.maxYClamp=this.canvas.height);var t=this.srcImage.height/this.srcImage.width,i=this.canvas.height/this.canvas.width,e=this.canvas.width,s=this.canvas.height;t<i?(e=this.canvas.width,s=this.canvas.width*t):(s=this.canvas.height,e=this.canvas.height/t),this.minXClamp=this.canvas.width/2-e/2,this.minYClamp=this.canvas.height/2-s/2,this.maxXClamp=this.canvas.width/2+e/2,this.maxYClamp=this.canvas.height/2+s/2},C.prototype.getCropBounds=function(){var t=this.canvas.height-2*this.minYClamp,i=this.getBounds();return i.top=Math.round((t-i.top+this.minYClamp)/this.ratioH),i.bottom=Math.round((t-i.bottom+this.minYClamp)/this.ratioH),i.left=Math.round((i.left-this.minXClamp)/this.ratioW),i.right=Math.round((i.right-this.minXClamp)/this.ratioW),i},C.prototype.clampPosition=function(t,i){return t<this.minXClamp&&(t=this.minXClamp),t>this.maxXClamp&&(t=this.maxXClamp),i<this.minYClamp&&(i=this.minYClamp),i>this.maxYClamp&&(i=this.maxYClamp),m.instance.borrow(t,i)},C.prototype.isImageSet=function(){return this.imageSet},C.prototype.setImage=function(t){if(!t)throw"Image is null";this.imageSet=!0,this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.buffer.getContext("2d").clearRect(0,0,this.buffer.width,this.buffer.height);var i=t.src.split(".")[1];"png"!=i&&"jpg"!=i||(this.fileType=i),this.srcImage=t,l.imageDimensions&&(l.imageDimensions.width=t.width,l.imageDimensions.height=t.height),this.updateClampBounds();var e=this.srcImage.height/this.srcImage.width,s=this.getBounds(),o=s.getHeight()/s.getWidth(),n=this.canvas.width,r=this.canvas.height;this.canvasWidth=n,this.canvasHeight=r;var a,h=this.canvas.width/2,c=this.canvas.height/2,g=m.instance.borrow(h-s.getWidth()/2,c+s.getHeight()/2),p=m.instance.borrow(h+s.getWidth()/2,c+s.getHeight()/2),u=m.instance.borrow(h-s.getWidth()/2,c-s.getHeight()/2),d=m.instance.borrow(h+s.getWidth()/2,c-s.getHeight()/2);this.tl.setPosition(g.x,g.y),this.tr.setPosition(p.x,p.y),this.bl.setPosition(u.x,u.y),this.br.setPosition(d.x,d.y),m.instance.returnPoint(g),m.instance.returnPoint(p),m.instance.returnPoint(u),m.instance.returnPoint(d),this.center.setPosition(h,c),d=e<o?(s=(i=Math.min(n*e,r))/o,g=m.instance.borrow(h-s/2,c+i/2),p=m.instance.borrow(h+s/2,c+i/2),u=m.instance.borrow(h-s/2,c-i/2),m.instance.borrow(h+s/2,c-i/2)):(u=(p=(g=(o=o<e?(a=Math.min(r/e,n))*o:(a=Math.min(r,n))*o,m.instance.borrow(h-a/2,c+o/2)),m.instance.borrow(h+a/2,c+o/2)),m.instance.borrow(h-a/2,c-o/2)),m.instance.borrow(h+a/2,c-o/2)),this.tl.setPosition(g.x,g.y),this.tr.setPosition(p.x,p.y),this.bl.setPosition(u.x,u.y),this.br.setPosition(d.x,d.y),m.instance.returnPoint(g),m.instance.returnPoint(p),m.instance.returnPoint(u),m.instance.returnPoint(d),this.vertSquashRatio=this.detectVerticalSquash(t),this.draw(this.ctx),this.applyCroppedImage(l.cropWidth,l.cropHeight),l.cropAreaBounds&&this.imageSet&&(l.cropAreaBounds=this.getCropBounds(),l.$apply())},C.prototype.applyCroppedImage=function(t,i){var e=this.getBounds();if(!this.srcImage)throw"Source image not set.";var s=this.srcImage.height/this.srcImage.width,o=this.canvas.height/this.canvas.width,n=this.canvas.width,r=this.canvas.height;s<o?(n=this.canvas.width,r=this.canvas.width*s):n=o<s?(r=this.canvas.height,this.canvas.height/s):(r=this.canvas.height,this.canvas.width),this.ratioW=n/this.srcImage.width,this.ratioH=r/this.srcImage.height,t&&i&&!l.allowOverstep?(this.cropCanvas.width=t,this.cropCanvas.height=i,o=(this.buffer.height-r)/2/this.ratioH,s=(this.buffer.width-n)/2/this.ratioW,this.drawImageIOSFix(this.cropCanvas.getContext("2d"),this.srcImage,Math.max(Math.round(e.left/this.ratioW-s),0),Math.max(Math.round(e.top/this.ratioH-o),0),Math.max(Math.round(e.getWidth()/this.ratioW),1),Math.max(Math.round(e.getHeight()/this.ratioH),1),0,0,t,i),this.croppedImage.width=t,this.croppedImage.height=i):(this.cropCanvas.width=Math.max(e.getWidth(),1),this.cropCanvas.height=Math.max(e.getHeight(),1),this.cropCanvas.getContext("2d").drawImage(this.buffer,e.left,e.top,Math.max(e.getWidth(),1),Math.max(e.getHeight(),1),0,0,e.getWidth(),e.getHeight()),this.croppedImage.width=this.cropCanvas.width,this.croppedImage.height=this.cropCanvas.height,this.srcImage.width,this.cropCanvas.width,this.srcImage.height,this.cropCanvas.height,e=this.getCropBounds(),n=(n/2-this.canvasWidth/2)/this.ratioW,r=(r/2-this.canvasHeight/2)/this.ratioH,this.cropCanvasFull.width=e.getWidth(),this.cropCanvasFull.height=-e.getHeight(),this.cropCanvasFull.getContext("2d").drawImage(this.srcImage,e.left+n,this.srcImage.height-(e.top-r),Math.max(e.getWidth(),1),Math.max(-e.getHeight(),1),0,0,e.getWidth(),-e.getHeight())),this.croppedImage.src=this.cropCanvas.toDataURL("image/"+this.fileType),this.croppedImageFull.src=this.cropCanvasFull.toDataURL("image/"+this.fileType),void 0!==a.croppedImage&&(l.croppedImage=this.croppedImage.src),void 0!==a.croppedImageFull&&(l.croppedImageFull=this.croppedImageFull.src)},C.prototype.getBounds=function(){for(var t=Number.MAX_VALUE,i=Number.MAX_VALUE,e=-Number.MAX_VALUE,s=-Number.MAX_VALUE,o=0;o<this.markers.length;o++){var n=this.markers[o];n.getPosition().x<t&&(t=n.getPosition().x),n.getPosition().x>e&&(e=n.getPosition().x),n.getPosition().y<i&&(i=n.getPosition().y),n.getPosition().y>s&&(s=n.getPosition().y)}var r=new f;return r.left=t,r.right=e,r.top=i,r.bottom=s,r},C.prototype.setBounds=function(t){for(var i,e,s,o,n=this.getBounds(),r=0;r<this.markers.length;r++){var a=this.markers[r];a.getPosition().x==n.left?a.getPosition().y==n.top?i=a:s=a:a.getPosition().y==n.top?e=a:o=a}i.setPosition(t.left,t.top),e.setPosition(t.right,t.top),s.setPosition(t.left,t.bottom),o.setPosition(t.right,t.bottom),this.center.recalculatePosition(t),this.center.draw(this.ctx)},C.prototype.getMousePos=function(t,i){t=t.getBoundingClientRect();return m.instance.borrow(i.clientX-t.left,i.clientY-t.top)},C.prototype.getTouchPos=function(t,i){t=t.getBoundingClientRect();return m.instance.borrow(i.clientX-t.left,i.clientY-t.top)},C.prototype.onTouchMove=function(t){if(r.isImageSet()){if(t.preventDefault(),1<=t.touches.length)for(var i=0;i<t.touches.length;i++){var e=t.touches[i],s=this.getTouchPos(this.canvas,e),e=new x(s.x,s.y,e.identifier);m.instance.returnPoint(s),this.move(e,t)}this.draw(this.ctx)}},C.prototype.onMouseMove=function(t){var i,e;r.isImageSet()&&(i=this.getMousePos(this.canvas,t),this.move(new x(i.x,i.y,0),t),(e=this.getDragTouchForID(0))?(e.x=i.x,e.y=i.y):e=new x(i.x,i.y,0),m.instance.returnPoint(i),this.drawCursors(e,t),this.draw(this.ctx))},C.prototype.move=function(t,i){this.isMouseDown&&this.handleMove(t)},C.prototype.getDragTouchForID=function(t){for(var i=0;i<this.currentDragTouches.length;i++)if(t==this.currentDragTouches[i].id)return this.currentDragTouches[i]},C.prototype.drawCursors=function(t,i){var e=!1;null!=t&&(t.dragHandle==this.center&&(I.setStyle(this.canvas,"move"),e=!0),null!=t.dragHandle&&t.dragHandle instanceof d&&(this.drawCornerCursor(t.dragHandle,t.dragHandle.getPosition().x,t.dragHandle.getPosition().y,i),e=!0));var s=!1;if(!e){for(var o=0;o<this.markers.length;o++)s=s||this.drawCornerCursor(this.markers[o],t.x,t.y,i);s||I.setStyle(this.canvas,"default")}s||e||!this.center.touchInBounds(t.x,t.y)?this.center.setOver(!1):(this.center.setOver(!0),I.setOver(this.canvas),I.setStyle(this.canvas,"move"))},C.prototype.drawCornerCursor=function(t,i,e,s){return t.touchInBounds(i,e)?(t.setOver(!0),t.getHorizontalNeighbour().getPosition().x>t.getPosition().x?t.getVerticalNeighbour().getPosition().y>t.getPosition().y?(I.setOver(this.canvas),I.setStyle(this.canvas,"nwse-resize")):(I.setOver(this.canvas),I.setStyle(this.canvas,"nesw-resize")):t.getVerticalNeighbour().getPosition().y>t.getPosition().y?(I.setOver(this.canvas),I.setStyle(this.canvas,"nesw-resize")):(I.setOver(this.canvas),I.setStyle(this.canvas,"nwse-resize")),!0):(t.setOver(!1),!1)},C.prototype.onTouchStart=function(t){r.isImageSet()&&(this.isMouseDown=!0)},C.prototype.onTouchEnd=function(t){if(r.isImageSet()){for(var i=0;i<t.changedTouches.length;i++){var e=t.changedTouches[i],e=this.getDragTouchForID(e.identifier);null!=e&&((e.dragHandle instanceof d||e.dragHandle instanceof g)&&e.dragHandle.setOver(!1),this.handleRelease(e))}r.isImageSet()&&this.currentlyInteracting&&(this.applyCroppedImage(l.cropWidth,l.cropHeight),l.$apply()),0==this.currentDragTouches.length&&(this.isMouseDown=!1,this.currentlyInteracting=!1)}},C.prototype.drawImageIOSFix=function(t,i,e,s,o,n,r,a,h,c){t.drawImage(i,e*this.vertSquashRatio,s*this.vertSquashRatio,o*this.vertSquashRatio,n*this.vertSquashRatio,r,a,h,c)},C.prototype.detectVerticalSquash=function(t){t.naturalWidth;var i=t.naturalHeight,e=document.createElement("canvas");e.width=1,e.height=i;e=e.getContext("2d");e.drawImage(t,0,0);for(var s=e.getImageData(0,0,1,i).data,o=0,n=i,r=i;o<r;)0===s[4*(r-1)+3]?n=r:o=r,r=n+o>>1;i=r/i;return 0==i?1:i},C.prototype.onMouseDown=function(t){r.isImageSet()&&(this.isMouseDown=!0)},C.prototype.onMouseUp=function(t){r.isImageSet()&&(I.setReleased(this.canvas),this.isMouseDown=!1,this.handleRelease(new x(0,0,0)),1==this.currentlyInteracting&&(this.applyCroppedImage(l.cropWidth,l.cropHeight),l.$apply()),this.currentlyInteracting=!1)},C);function C(t,i,e,s,o,n,r){void 0===i&&(i=0),void 0===e&&(e=0),void 0===s&&(s=100),void 0===o&&(o=50),void 0===n&&(n=!0),void 0===r&&(r=20),this.keepAspect=!1,this.aspectRatio=0,this.currentDragTouches=new Array,this.isMouseDown=!1,this.ratioW=1,this.ratioH=1,this.fileType="png",this.imageSet=!1,this.pointPool=new m(200),h.init(t),this.buffer=document.createElement("canvas"),this.cropCanvas=document.createElement("canvas"),this.cropCanvasFull=document.createElement("canvas"),this.buffer.width=t.width,this.buffer.height=t.height,this.tl=new d(i,e,r),this.tr=new d(i+s,e,r),this.bl=new d(i,e+o,r),this.br=new d(i+s,e+o,r),this.tl.addHorizontalNeighbour(this.tr),this.tl.addVerticalNeighbour(this.bl),this.tr.addHorizontalNeighbour(this.tl),this.tr.addVerticalNeighbour(this.br),this.bl.addHorizontalNeighbour(this.br),this.bl.addVerticalNeighbour(this.tl),this.br.addHorizontalNeighbour(this.bl),this.br.addVerticalNeighbour(this.tr),this.markers=[this.tl,this.tr,this.bl,this.br],this.center=new g(i+s/2,e+o/2,r),this.canvas=t,this.ctx=this.canvas.getContext("2d"),this.keepAspect=n,this.aspectRatio=o/s,this.draw(this.ctx),this.croppedImage=new Image,this.croppedImageFull=new Image,this.currentlyInteracting=!1,window.addEventListener("mousemove",this.onMouseMove.bind(this)),window.addEventListener("mouseup",this.onMouseUp.bind(this)),t.addEventListener("mousedown",this.onMouseDown.bind(this)),window.addEventListener("touchmove",this.onTouchMove.bind(this),!1),t.addEventListener("touchstart",this.onTouchStart.bind(this),!1),window.addEventListener("touchend",this.onTouchEnd.bind(this),!1)}angular.element(document).ready(function(){var t=angular.element(n[0])[0],i=l.cropWidth,e=l.cropHeight,s=l.keepAspect,o=l.touchRadius;r=new P(t,t.width/2-i/2,t.height/2-e/2,i,e,s,o)}),l.$watch("image",function(t){var i;null!=t&&(i=new Image,void 0!==a.cors&&"no"!==a.cors&&(i.crossOrigin="Anonymous"),i.addEventListener("load",function(){r.setImage(i),r.applyCroppedImage(l.cropWidth,l.cropHeight),l.$apply()},!1),i.src=t)})}}}]),angular.module("angular-img-cropper").directive("imgCropperFileread",["$timeout",function(s){return{scope:{image:"=",fileSizeInBytes:"="},link:function(e,t){t.bind("change",function(t){var i=new FileReader;i.onload=function(t){s(function(){e.image=t.target.result,void 0!==e.fileSizeInBytes&&(e.fileSizeInBytes=Math.ceil(.75*e.image.length))},0)},t.target.files[0]&&i.readAsDataURL(t.target.files[0])})}}}]),angular.module("angular-img-cropper").directive("imgCropperFilereadCall",function(){return{scope:{control:"="},link:function(t){t.internalControl=t.control||{},t.internalControl.load=function(t){var i=angular.element(document.querySelector(t)),t=document.createEvent("MouseEvent");t.initEvent("click",!0,!1),i[0].dispatchEvent(t)}}}}),angular.module("angular-img-cropper").factory("imageCropperDataShare",function(){var e,s,t={setPressed:function(t){e=t},setReleased:function(t){t===e&&(e=void 0)},setOver:function(t){s=t},setStyle:function(t,i){void 0!==e?e===t&&angular.element(document.documentElement).css("cursor",i):t===s&&angular.element(document.documentElement).css("cursor",i)}};return t});